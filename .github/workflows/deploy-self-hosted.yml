name: Deploy to Play Store (Self-Hosted)

on:
  push:
    branches: [ main ]
    tags: [ 'v*' ]
  workflow_dispatch:
    inputs:
      flavor:
        description: 'Flavor to deploy'
        required: true
        default: 'pace'
        type: choice
        options:
          - pace
          - gaes
          - cbsa
          - dpsa
          - iiss
          - pbss
          - pcbs
          - pmbs
          - sisd

env:
  FLUTTER_VERSION: '3.35.4'

jobs:
  deploy:
    runs-on: self-hosted  # Use your self-hosted runner
    
    strategy:
      matrix:
        flavor: [pace, gaes, cbsa, dpsa, iiss, pbss, pcbs, pmbs, sisd]
        include:
          - flavor: pace
            package_name: com.pacesharjah.schoolapp
            app_name: PACE INTL
            key_file: pace_key.jks
            key_alias: pace
            icon_config: flutter_launcher_icons-pace.yaml
            target_file: lib/schools/pace/pace_main.dart
          - flavor: gaes
            package_name: com.gaes.schoolapp
            app_name: GAES
            key_file: gaes.key
            key_alias: key0
            icon_config: flutter_launcher_icons-gaes.yaml
            target_file: lib/schools/gaes/gaes_main.dart
          - flavor: cbsa
            package_name: com.cbsa.schoolapp
            app_name: CBSA
            key_file: pace_key.jks
            key_alias: pace
            icon_config: flutter_launcher_icons-cbsa.yaml
            target_file: lib/schools/cbsa/cbsa_main.dart
          - flavor: dpsa
            package_name: com.dpsa.schoolapp
            app_name: DPSA
            key_file: pace_key.jks
            key_alias: pace
            icon_config: flutter_launcher_icons-dpsa.yaml
            target_file: lib/schools/dpsa/dpsa_main.dart
          - flavor: iiss
            package_name: com.iiss.schoolapp
            app_name: IISS
            key_file: pace_key.jks
            key_alias: pace
            icon_config: flutter_launcher_icons-iiss.yaml
            target_file: lib/schools/iiss/iiss_main.dart
          - flavor: pbss
            package_name: com.pbss.schoolapp
            app_name: PBSS
            key_file: pace_key.jks
            key_alias: pace
            icon_config: flutter_launcher_icons-pbss.yaml
            target_file: lib/schools/pbss/pbss_main.dart
          - flavor: pcbs
            package_name: com.pcbs.schoolapp
            app_name: PCBS
            key_file: pace_key.jks
            key_alias: pace
            icon_config: flutter_launcher_icons-pcbs.yaml
            target_file: lib/schools/pcbs/pcbs_main.dart
          - flavor: pmbs
            package_name: com.pmbs.schoolapp
            app_name: PMBS
            key_file: pace_key.jks
            key_alias: pace
            icon_config: flutter_launcher_icons-pmbs.yaml
            target_file: lib/schools/pmbs/pmbs_main.dart
          - flavor: sisd
            package_name: com.sisd.schoolapp
            app_name: SISD
            key_file: pace_key.jks
            key_alias: pace
            icon_config: flutter_launcher_icons-sisd.yaml
            target_file: lib/schools/sisd/sisd_main.dart
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup Java
      uses: actions/setup-java@v4
      with:
        distribution: 'zulu'
        java-version: '17'

    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.35.4'
        channel: 'stable'

    - name: Check Dart version
      run: |
        dart --version
        flutter --version

    - name: Get dependencies
      timeout-minutes: 5
      run: |
        echo "Getting Flutter dependencies..."
        flutter pub get
        echo "Dependencies resolved successfully"

    - name: Generate icons
      timeout-minutes: 3
      run: |
        echo "Generating app icons for ${{ matrix.flavor }}..."
        if [ -f "${{ matrix.icon_config }}" ]; then
          flutter pub run flutter_launcher_icons:main -f ${{ matrix.icon_config }}
          echo "Icons generated successfully for ${{ matrix.flavor }}"
        else
          echo "No icon config found for ${{ matrix.flavor }}, skipping icon generation"
        fi

    - name: Setup signing
      timeout-minutes: 2
      run: |
        echo "Setting up signing configuration for ${{ matrix.flavor }}..."
        if [ "${{ matrix.flavor }}" = "gaes" ]; then
          # GAES uses different credentials
          cat > android/key.properties << 'EOF'
        storePassword=${{ secrets.GAES_STORE_PASSWORD }}
        keyAlias=${{ matrix.key_alias }}
        keyPassword=${{ secrets.GAES_KEY_PASSWORD }}
        storeFile=../${{ matrix.key_file }}
        EOF
          
          echo "${{ secrets.GAES_KEYSTORE_BASE64 }}" | base64 --decode > android/${{ matrix.key_file }}
        else
          # All other flavors use PACE credentials
          cat > android/key.properties << 'EOF'
        storePassword=${{ secrets.PACE_STORE_PASSWORD }}
        keyAlias=${{ matrix.key_alias }}
        keyPassword=${{ secrets.PACE_KEY_PASSWORD }}
        storeFile=../${{ matrix.key_file }}
        EOF
          
          echo "${{ secrets.PACE_KEYSTORE_BASE64 }}" | base64 --decode > android/${{ matrix.key_file }}
        fi
        
        chmod 600 android/${{ matrix.key_file }}
        echo "Signing setup completed for ${{ matrix.flavor }}"

    - name: Build AAB
      timeout-minutes: 10
      run: |
        echo "Starting Flutter build for ${{ matrix.flavor }}..."
        flutter build appbundle --release --flavor ${{ matrix.flavor }} --target ${{ matrix.target_file }} --verbose
        echo "Flutter build completed successfully for ${{ matrix.flavor }}"

    - name: Verify AAB file
      run: |
        echo "Checking if AAB file was created for ${{ matrix.flavor }}..."
        AAB_PATH="build/app/outputs/bundle/${{ matrix.flavor }}Release/app-${{ matrix.flavor }}-release.aab"
        if [ -f "$AAB_PATH" ]; then
          echo "âœ… AAB file found for ${{ matrix.flavor }}:"
          ls -la "$AAB_PATH"
        else
          echo "âŒ AAB file not found for ${{ matrix.flavor }}!"
          echo "Build directory contents:"
          find build -name "*.aab" -type f 2>/dev/null || echo "No AAB files found"
          exit 1
        fi

    - name: Clean up build artifacts
      run: |
        echo "Cleaning up unnecessary build artifacts to save storage..."
        # Keep only the AAB file we need
        find build -name "*.apk" -delete 2>/dev/null || true
        find build -name "*.dex" -delete 2>/dev/null || true
        find build -name "*.class" -delete 2>/dev/null || true
        find build -name "*.jar" -delete 2>/dev/null || true
        # Remove intermediate build files
        rm -rf build/app/intermediates 2>/dev/null || true
        rm -rf build/app/tmp 2>/dev/null || true
        echo "Build cleanup completed"

    - name: Upload AAB artifact
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.flavor }}-aab
        path: build/app/outputs/bundle/${{ matrix.flavor }}Release/app-${{ matrix.flavor }}-release.aab
        retention-days: 1

    - name: Determine deployment track
      id: track
      run: |
        # Always deploy to internal track for safety
        TRACK="internal"
        
        echo "track=$TRACK" >> $GITHUB_OUTPUT
        echo "Deploying to track: $TRACK"

    - name: Upload to Play Store
      uses: r0adkll/upload-google-play@v1
      with:
        serviceAccountJsonPlainText: ${{ secrets.GOOGLE_PLAY_SERVICE_ACCOUNT_JSON }}
        packageName: ${{ matrix.package_name }}
        releaseFiles: build/app/outputs/bundle/${{ matrix.flavor }}Release/app-${{ matrix.flavor }}-release.aab
        track: ${{ steps.track.outputs.track }}
        status: completed
        changesNotSentForReview: false

    - name: Create Release
      if: startsWith(github.ref, 'refs/tags/')
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ github.ref }}
        release_name: Release ${{ github.ref }} - ${{ matrix.app_name }}
        body: |
          ## Flavor: ${{ matrix.flavor }}
          - **App ID**: ${{ matrix.package_name }}
          - **App Name**: ${{ matrix.app_name }}
          - **Build Type**: Release
          - **Track**: internal
          
          ### Downloads
          - [AAB](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
        draft: false
        prerelease: false

    - name: Deployment Summary
      run: |
        echo "## ðŸš€ Deployment Successful for ${{ matrix.flavor }}" >> $GITHUB_STEP_SUMMARY
        echo "- **App ID**: ${{ matrix.package_name }}" >> $GITHUB_STEP_SUMMARY
        echo "- **App Name**: ${{ matrix.app_name }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Track**: internal" >> $GITHUB_STEP_SUMMARY
        echo "- **Build**: âœ… Completed" >> $GITHUB_STEP_SUMMARY
        echo "- **Upload**: âœ… Completed" >> $GITHUB_STEP_SUMMARY

    - name: Cleanup
      if: always()
      run: |
        rm -f android/${{ matrix.key_file }}
        rm -f android/key.properties
