name: Auto Deploy to Play Store

on:
  push:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      track:
        description: 'Play Store Track'
        required: true
        default: 'internal'
        type: choice
        options: [internal, alpha, beta, production]

jobs:
  auto-deploy:
    runs-on: [self-hosted, macOS]   # âœ… matches your runner labels

    strategy:
      matrix:
        flavor: [pace, gaes, cbsa, dpsa, iiss, pbss, pcbs, pmbs, sisd]
        include:
          - flavor: pace
            key_file: pace_key.jks
            key_alias: pace
            package_name: com.pacesharjah.schoolapp
          - flavor: gaes
            key_file: gaes.key
            key_alias: key0
            package_name: com.gaes.schoolapp
          - flavor: cbsa
            key_file: pace_key.jks
            key_alias: pace
            package_name: com.cbsa.schoolapp
          - flavor: dpsa
            key_file: pace_key.jks
            key_alias: pace
            package_name: com.dpsa.schoolapp
          - flavor: iiss
            key_file: pace_key.jks
            key_alias: pace
            package_name: com.iiss.schoolapp
          - flavor: pbss
            key_file: pace_key.jks
            key_alias: pace
            package_name: com.pbss.schoolapp
          - flavor: pcbs
            key_file: pace_key.jks
            key_alias: pace
            package_name: com.pcbs.schoolapp
          - flavor: pmbs
            key_file: pace_key.jks
            key_alias: pace
            package_name: com.pmbs.schoolapp
          - flavor: sisd
            key_file: pace_key.jks
            key_alias: pace
            package_name: com.sisd.schoolapp

    steps:
    - name: ðŸ§¾ Checkout Repository
      uses: actions/checkout@v4

    # -------------------------------------------------------------
    # ENVIRONMENT SETUP
    # -------------------------------------------------------------
    - name: ðŸ§© Setup Environment
      run: |
        echo "ðŸš€ Setting up environment for auto-deploy..."
        echo "Flavor: ${{ matrix.flavor }}"
        echo "Package: ${{ matrix.package_name }}"
        echo "Track: ${{ github.event.inputs.track || 'internal' }}"
        
        # âœ… Use Bash-safe environment file instead of zshrc
        if [ -f "$HOME/.env_setup.sh" ]; then
          source "$HOME/.env_setup.sh"
        else
          echo "âš ï¸ ~/.env_setup.sh not found, using defaults"
          export ANDROID_HOME="$HOME/Library/Android/sdk"
          export JAVA_HOME=$(/usr/libexec/java_home)
          export PATH="$PATH:$HOME/flutter/bin:$ANDROID_HOME/tools:$ANDROID_HOME/platform-tools"
        fi
        
        # Verify toolchain
        echo "ðŸ” Checking environment..."
        command -v flutter >/dev/null || { echo "âŒ Flutter not found!"; exit 1; }
        [ -z "$ANDROID_HOME" ] && { echo "âŒ ANDROID_HOME missing!"; exit 1; }

        echo "âœ… Environment ready"
        echo "Flutter: $(flutter --version | head -1)"
        echo "Android SDK: $ANDROID_HOME"
        echo "Java: $(java -version 2>&1 | head -1)"
      shell: bash

    # -------------------------------------------------------------
    # FLUTTER BUILD
    # -------------------------------------------------------------
    - name: ðŸ“¦ Get Dependencies
      run: flutter pub get
      shell: bash

    - name: ðŸŽ¨ Generate Icons
      run: |
        echo "Generating icons for ${{ matrix.flavor }}..."
        ICON_FILE="flutter_launcher_icons-${{ matrix.flavor }}.yaml"
        if [ -f "$ICON_FILE" ]; then
          flutter pub run flutter_launcher_icons:main -f "$ICON_FILE"
        else
          echo "â„¹ï¸ No icon config for ${{ matrix.flavor }} â€” skipping"
        fi
      shell: bash

    - name: ðŸ” Setup Signing
      run: |
        echo "Setting up signing for ${{ matrix.flavor }}..."
        if [ "${{ matrix.flavor }}" = "gaes" ]; then
          echo "storePassword=${{ secrets.GAES_STORE_PASSWORD }}" > android/key.properties
          echo "keyAlias=${{ matrix.key_alias }}" >> android/key.properties
          echo "keyPassword=${{ secrets.GAES_KEY_PASSWORD }}" >> android/key.properties
          echo "storeFile=../${{ matrix.key_file }}" >> android/key.properties
          echo "${{ secrets.GAES_KEYSTORE_BASE64 }}" | base64 --decode > android/${{ matrix.key_file }}
        else
          echo "storePassword=${{ secrets.PACE_STORE_PASSWORD }}" > android/key.properties
          echo "keyAlias=${{ matrix.key_alias }}" >> android/key.properties
          echo "keyPassword=${{ secrets.PACE_KEY_PASSWORD }}" >> android/key.properties
          echo "storeFile=../${{ matrix.key_file }}" >> android/key.properties
          echo "${{ secrets.PACE_KEYSTORE_BASE64 }}" | base64 --decode > android/${{ matrix.key_file }}
        fi
        chmod 600 android/${{ matrix.key_file }}
        echo "âœ… Signing ready"
      shell: bash

    - name: ðŸ”¨ Build AAB
      run: |
        echo "Building release AAB for ${{ matrix.flavor }}..."
        flutter build appbundle --release \
          --flavor "${{ matrix.flavor }}" \
          --target "lib/schools/${{ matrix.flavor }}/${{ matrix.flavor }}_main.dart" \
          --verbose
        echo "âœ… Build complete"
      shell: bash

    - name: ðŸ§¾ Verify AAB
      run: |
        AAB_PATH="build/app/outputs/bundle/${{ matrix.flavor }}Release/app-${{ matrix.flavor }}-release.aab"
        if [ -f "$AAB_PATH" ]; then
          echo "âœ… Found: $AAB_PATH ($(ls -lh "$AAB_PATH" | awk '{print $5}'))"
        else
          echo "âŒ AAB not found!"
          exit 1
        fi
      shell: bash

    # -------------------------------------------------------------
    # PLAY STORE UPLOAD
    # -------------------------------------------------------------
    - name: ðŸš€ Upload to Play Store
      uses: r0adkll/upload-google-play@v1
      with:
        serviceAccountJsonPlainText: ${{ secrets.GOOGLE_PLAY_SERVICE_ACCOUNT_JSON }}
        packageName: ${{ matrix.package_name }}
        releaseFiles: build/app/outputs/bundle/${{ matrix.flavor }}Release/app-${{ matrix.flavor }}-release.aab
        track: ${{ github.event.inputs.track || 'internal' }}
        status: completed
        changesNotSentForReview: true    # âœ… avoids userFraction errors
        inAppUpdatePriority: 2

    # -------------------------------------------------------------
    # LOCAL STORAGE & SUMMARY
    # -------------------------------------------------------------
    - name: ðŸ’¾ Store AAB Locally
      run: |
        DEPLOY_DIR="$HOME/playstore-deployments/${{ github.run_id }}"
        mkdir -p "$DEPLOY_DIR"
        cp "build/app/outputs/bundle/${{ matrix.flavor }}Release/app-${{ matrix.flavor }}-release.aab" \
          "$DEPLOY_DIR/${{ matrix.flavor }}-release.aab"
        echo "âœ… Stored at $DEPLOY_DIR"
      shell: bash

    - name: ðŸ§¾ Create Deployment Summary
      run: |
        DEPLOY_DIR="$HOME/playstore-deployments/${{ github.run_id }}"
        SUMMARY="$DEPLOY_DIR/deployment_summary.txt"

        echo "Play Store Auto-Deploy Summary" > "$SUMMARY"
        echo "=============================" >> "$SUMMARY"
        echo "Date: $(date)" >> "$SUMMARY"
        echo "Branch: ${{ github.ref_name }}" >> "$SUMMARY"
        echo "Track: ${{ github.event.inputs.track || 'internal' }}" >> "$SUMMARY"
        echo "Commit: ${{ github.sha }}" >> "$SUMMARY"
        echo "" >> "$SUMMARY"
        echo "Flavors Deployed:" >> "$SUMMARY"

        for f in pace gaes cbsa dpsa iiss pbss pcbs pmbs sisd; do
          if [ -f "$DEPLOY_DIR/$f-release.aab" ]; then
            size=$(ls -lh "$DEPLOY_DIR/$f-release.aab" | awk '{print $5}')
            echo "- $f: âœ… ($size)" >> "$SUMMARY"
          else
            echo "- $f: âŒ Failed" >> "$SUMMARY"
          fi
        done

        echo "âœ… Summary saved at $SUMMARY"
      shell: bash

    # -------------------------------------------------------------
    # CLEANUP
    # -------------------------------------------------------------
    - name: ðŸ§¹ Cleanup
      if: always()
      run: |
        echo "Cleaning up temporary files..."
        rm -f android/key.properties android/*.jks
        flutter clean
        rm -rf /tmp/flutter_*
        echo "âœ… Cleanup done"
      shell: bash
