name: Auto Deploy to Play Store

on:
  push:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      track:
        description: 'Play Store Track'
        required: true
        default: 'internal'
        type: choice
        options:
        - internal
        - alpha
        - beta
        - production

jobs:
  auto-deploy:
    runs-on: [self-hosted, macos, aws]  # Self-hosted AWS macOS runner
    
    strategy:
      matrix:
        flavor: [pace, gaes, cbsa, dpsa, iiss, pbss, pcbs, pmbs, sisd]
        include:
          - flavor: pace
            key_file: pace_key.jks
            key_alias: pace
            package_name: com.pacesharjah.schoolapp
          - flavor: gaes
            key_file: gaes.key
            key_alias: key0
            package_name: com.pacesharjah.schoolapp
          - flavor: cbsa
            key_file: pace_key.jks
            key_alias: pace
            package_name: com.pacesharjah.schoolapp
          - flavor: dpsa
            key_file: pace_key.jks
            key_alias: pace
            package_name: com.pacesharjah.schoolapp
          - flavor: iiss
            key_file: pace_key.jks
            key_alias: pace
            package_name: com.pacesharjah.schoolapp
          - flavor: pbss
            key_file: pace_key.jks
            key_alias: pace
            package_name: com.pacesharjah.schoolapp
          - flavor: pcbs
            key_file: pace_key.jks
            key_alias: pace
            package_name: com.pacesharjah.schoolapp
          - flavor: pmbs
            key_file: pace_key.jks
            key_alias: pace
            package_name: com.pacesharjah.schoolapp
          - flavor: sisd
            key_file: pace_key.jks
            key_alias: pace
            package_name: com.pacesharjah.schoolapp
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Environment
      run: |
        echo "ðŸš€ Setting up environment for auto-deploy on AWS Mac..."
        echo "Flavor: ${{ matrix.flavor }}"
        echo "Package: ${{ matrix.package_name }}"
        echo "Track: ${{ github.event.inputs.track || 'internal' }}"
        
        # Source environment variables from ~/.zshrc (set up by setup-aws-mac.sh)
        source ~/.zshrc
        
        # Verify Flutter installation
        if ! command -v flutter &> /dev/null; then
          echo "âŒ Flutter not found. Please ensure setup-aws-mac.sh was run."
          exit 1
        fi
        
        # Verify Android SDK
        if [ -z "$ANDROID_HOME" ]; then
          echo "âŒ ANDROID_HOME not set. Please ensure setup-aws-mac.sh was run."
          exit 1
        fi
        
        echo "âœ… Environment ready"
        echo "Flutter: $(which flutter) - $(flutter --version | head -1)"
        echo "Android SDK: $ANDROID_HOME"
        echo "Java: $(java -version 2>&1 | head -1)"
    
    - name: Get Dependencies
      run: |
        echo "ðŸ“¦ Getting Flutter dependencies..."
        flutter pub get
        
    - name: Generate Icons
      run: |
        echo "ðŸŽ¨ Generating icons for ${{ matrix.flavor }}..."
        if [ -f "flutter_launcher_icons-${{ matrix.flavor }}.yaml" ]; then
          flutter pub run flutter_launcher_icons:main -f "flutter_launcher_icons-${{ matrix.flavor }}.yaml"
        else
          echo "No icon config found for ${{ matrix.flavor }}, using default"
        fi
        
    - name: Setup Signing
      run: |
        echo "ðŸ” Setting up signing for ${{ matrix.flavor }}..."
        
        # Source environment variables
        source ~/.zshrc
        
        if [ "${{ matrix.flavor }}" = "gaes" ]; then
          # GAES uses different credentials
          cat > android/key.properties << 'EOF'
        storePassword=${{ secrets.GAES_STORE_PASSWORD }}
        keyAlias=${{ matrix.key_alias }}
        keyPassword=${{ secrets.GAES_KEY_PASSWORD }}
        storeFile=../${{ matrix.key_file }}
        EOF
          
          echo "${{ secrets.GAES_KEYSTORE_BASE64 }}" | base64 --decode > android/${{ matrix.key_file }}
        else
          # All other flavors use PACE credentials
          cat > android/key.properties << 'EOF'
        storePassword=${{ secrets.PACE_STORE_PASSWORD }}
        keyAlias=${{ matrix.key_alias }}
        keyPassword=${{ secrets.PACE_KEY_PASSWORD }}
        storeFile=../${{ matrix.key_file }}
        EOF
          
          echo "${{ secrets.PACE_KEYSTORE_BASE64 }}" | base64 --decode > android/${{ matrix.key_file }}
        fi
        
        chmod 600 android/${{ matrix.key_file }}
        echo "âœ… Signing setup completed for ${{ matrix.flavor }}"
        
    - name: Build AAB
      run: |
        echo "ðŸ”¨ Building AAB for ${{ matrix.flavor }}..."
        
        # Source environment variables
        source ~/.zshrc
        
        flutter build appbundle --release --flavor "${{ matrix.flavor }}" --target "lib/schools/${{ matrix.flavor }}/${matrix.flavor}_main.dart" --verbose
        
        echo "âœ… AAB build completed"
        
    - name: Verify AAB
      run: |
        AAB_PATH="build/app/outputs/bundle/${{ matrix.flavor }}Release/app-${{ matrix.flavor }}-release.aab"
        if [ -f "$AAB_PATH" ]; then
          echo "âœ… AAB file found: $AAB_PATH"
          ls -lh "$AAB_PATH"
        else
          echo "âŒ AAB file not found!"
          exit 1
        fi
        
    - name: Upload to Play Store
      uses: r0adkll/upload-google-play@v1
      with:
        serviceAccountJsonPlainText: ${{ secrets.GOOGLE_PLAY_SERVICE_ACCOUNT_JSON }}
        packageName: ${{ matrix.package_name }}
        releaseFiles: build/app/outputs/bundle/${{ matrix.flavor }}Release/app-${{ matrix.flavor }}-release.aab
        track: ${{ github.event.inputs.track || 'internal' }}
        status: completed
        inAppUpdatePriority: 2
        userFraction: "0.99"
        
    - name: Store AAB Locally
      run: |
        echo "ðŸ’¾ Storing AAB locally on self-hosted runner..."
        AAB_PATH="build/app/outputs/bundle/${{ matrix.flavor }}Release/app-${{ matrix.flavor }}-release.aab"
        
        # Create local storage directory
        mkdir -p ~/playstore-deployments/${{ github.run_id }}
        
        # Copy AAB to local storage
        cp "$AAB_PATH" ~/playstore-deployments/${{ github.run_id }}/${{ matrix.flavor }}-release.aab
        
        echo "âœ… AAB stored locally at: ~/playstore-deployments/${{ github.run_id }}/${{ matrix.flavor }}-release.aab"
        echo "File size: $(ls -lh ~/playstore-deployments/${{ github.run_id }}/${{ matrix.flavor }}-release.aab | awk '{print $5}')"
        
    - name: Create Deployment Summary
      run: |
        echo "ðŸ“‹ Creating deployment summary..."
        DEPLOY_DIR=~/playstore-deployments/${{ github.run_id }}
        mkdir -p "$DEPLOY_DIR"
        
        cat > "$DEPLOY_DIR/deployment_summary.txt" << EOF
        Play Store Auto-Deploy Summary
        =============================
        
        Deployment Date: $(date)
        Triggered by: ${{ github.event.head_commit.message }}
        Commit: ${{ github.sha }}
        Branch: ${{ github.ref_name }}
        Track: ${{ github.event.inputs.track || 'internal' }}
        
        Flavors Deployed:
        EOF
        
        for flavor in pace gaes cbsa dpsa iiss pbss pcbs pmbs sisd; do
          if [ -f "$DEPLOY_DIR/$flavor-release.aab" ]; then
            size=$(ls -lh "$DEPLOY_DIR/$flavor-release.aab" | awk '{print $5}')
            echo "- $flavor: âœ… Deployed to Play Store ($size)" >> "$DEPLOY_DIR/deployment_summary.txt"
          else
            echo "- $flavor: âŒ Failed" >> "$DEPLOY_DIR/deployment_summary.txt"
          fi
        done
        
        echo "Deployment summary saved to: $DEPLOY_DIR/deployment_summary.txt"
        
    - name: Cleanup
      if: always()
      run: |
        echo "ðŸ§¹ Cleaning up AWS Mac runner..."
        
        # Source environment variables
        source ~/.zshrc
        
        # Clean up signing files
        rm -f android/key.properties
        rm -f android/${{ matrix.key_file }}
        
        # Clean Flutter build cache
        flutter clean
        
        # Clean up any temporary files
        rm -rf /tmp/flutter_*
        
        echo "âœ… Cleanup completed"
