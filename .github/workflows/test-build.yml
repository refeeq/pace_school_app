name: Test Build

on:
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:
    # Only builds pace flavor for testing

env:
  FLUTTER_VERSION: '3.35.4'

jobs:
  test-build:
    runs-on: ubuntu-latest
    
    # Only build pace flavor for testing
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup Java
      uses: actions/setup-java@v4
      with:
        distribution: 'zulu'
        java-version: '17'

    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.35.4'
        channel: 'stable'

    - name: Check Dart version
      run: |
        dart --version
        flutter --version

    - name: Get dependencies
      run: flutter pub get


    - name: Generate icons
      run: |
        if [ -f "flutter_launcher_icons-pace.yaml" ]; then
          flutter pub run flutter_launcher_icons:main -f flutter_launcher_icons-pace.yaml
        fi

    - name: Setup signing
      run: |
        # Setup signing for pace flavor
        cat > android/key.properties << 'EOF'
        storePassword=${{ secrets.PACE_STORE_PASSWORD }}
        keyAlias=pace
        keyPassword=${{ secrets.PACE_KEY_PASSWORD }}
        storeFile=../pace_key.jks
        EOF
        
        echo "${{ secrets.PACE_KEYSTORE_BASE64 }}" | base64 --decode > android/pace_key.jks
        chmod 600 android/pace_key.jks

    - name: Setup Gradle Wrapper
      run: |
        cd android
        chmod +x gradlew
        ./gradlew --version

    - name: Build APK (Debug)
      run: |
        cd android
        ./gradlew assemblepaceDebug

    - name: Build APK (Release)
      run: |
        cd android
        ./gradlew assemblepaceRelease

    - name: Build AAB (Release)
      run: |
        cd android
        ./gradlew bundlepaceRelease

    - name: Upload APK artifacts
      uses: actions/upload-artifact@v4
      with:
        name: pace-apk
        path: |
          build/app/outputs/flutter-apk/app-pace-debug.apk
          build/app/outputs/flutter-apk/app-pace-release.apk
        retention-days: 7

    - name: Upload AAB artifact
      uses: actions/upload-artifact@v4
      with:
        name: pace-aab
        path: build/app/outputs/bundle/paceRelease/app-pace-release.aab
        retention-days: 7

    - name: Build Summary
      run: |
        echo "## ✅ Build Successful for pace" >> $GITHUB_STEP_SUMMARY
        echo "- **App ID**: com.pacesharjah.schoolapp" >> $GITHUB_STEP_SUMMARY
        echo "- **Debug APK**: ✅ Built" >> $GITHUB_STEP_SUMMARY
        echo "- **Release APK**: ✅ Built" >> $GITHUB_STEP_SUMMARY
        echo "- **Release AAB**: ✅ Built" >> $GITHUB_STEP_SUMMARY
        echo "- **Code Analysis**: ✅ Passed" >> $GITHUB_STEP_SUMMARY
        echo "- **Tests**: ✅ Passed" >> $GITHUB_STEP_SUMMARY

    - name: Cleanup
      if: always()
      run: |
        rm -f android/pace_key.jks
        rm -f android/key.properties
