name: Test Build

on:
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:
    inputs:
      flavor:
        description: 'Flavor to test build'
        required: true
        default: 'pace'
        type: choice
        options:
          - pace
          - iiss
          - gaes
          - cbsa
          - dpsa
          - pmbs
          - pcbs
          - pbss
          - sisd
          - demo

env:
  FLUTTER_VERSION: '3.35.4'

jobs:
  test-build:
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        include:
          - flavor: pace
            app_id: com.pacesharjah.schoolapp
            key_file: pace_key.jks
            key_alias: pace
          - flavor: iiss
            app_id: com.iiss.schoolapp
            key_file: pace_key.jks
            key_alias: pace
          - flavor: gaes
            app_id: com.gaes.schoolapp
            key_file: gaes.key
            key_alias: key0
          - flavor: cbsa
            app_id: com.cbsa.schoolapp
            key_file: pace_key.jks
            key_alias: pace
          - flavor: dpsa
            app_id: com.dpsa.schoolapp
            key_file: pace_key.jks
            key_alias: pace
          - flavor: pmbs
            app_id: com.pmbs.schoolapp
            key_file: pace_key.jks
            key_alias: pace
          - flavor: pcbs
            app_id: com.pcbs.schoolapp
            key_file: pace_key.jks
            key_alias: pace
          - flavor: pbss
            app_id: com.pbss.schoolapp
            key_file: pace_key.jks
            key_alias: pace
          - flavor: sisd
            app_id: com.sisd.schoolapp
            key_file: pace_key.jks
            key_alias: pace
          - flavor: demo
            app_id: com.demo.schoolapp
            key_file: pace_key.jks
            key_alias: pace

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup Java
      uses: actions/setup-java@v4
      with:
        distribution: 'zulu'
        java-version: '17'

    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.35.4'
        channel: 'stable'

    - name: Check Dart version
      run: |
        dart --version
        flutter --version

    - name: Get dependencies
      run: flutter pub get

    - name: Analyze code
      run: flutter analyze

    - name: Run tests
      run: flutter test

    - name: Generate icons
      run: |
        if [ -f "flutter_launcher_icons-${{ matrix.flavor }}.yaml" ]; then
          flutter pub run flutter_launcher_icons:main -f flutter_launcher_icons-${{ matrix.flavor }}.yaml
        fi

    - name: Setup signing
      run: |
        # Create key.properties based on flavor
        if [ "${{ matrix.flavor }}" = "gaes" ]; then
          # GAES uses different credentials
          cat > android/key.properties << EOF
          storePassword=${{ secrets.GAES_STORE_PASSWORD }}
          keyAlias=${{ matrix.key_alias }}
          keyPassword=${{ secrets.GAES_KEY_PASSWORD }}
          storeFile=../${{ matrix.key_file }}
          EOF
          
          echo "${{ secrets.GAES_KEYSTORE_BASE64 }}" | base64 --decode > android/${{ matrix.key_file }}
        else
          # All other flavors use PACE credentials
          cat > android/key.properties << EOF
          storePassword=${{ secrets.PACE_STORE_PASSWORD }}
          keyAlias=${{ matrix.key_alias }}
          keyPassword=${{ secrets.PACE_KEY_PASSWORD }}
          storeFile=../${{ matrix.key_file }}
          EOF
          
          echo "${{ secrets.PACE_KEYSTORE_BASE64 }}" | base64 --decode > android/${{ matrix.key_file }}
        fi
        
        chmod 600 android/${{ matrix.key_file }}

    - name: Build APK (Debug)
      run: |
        cd android
        ./gradlew assemble${{ matrix.flavor }}Debug

    - name: Build APK (Release)
      run: |
        cd android
        ./gradlew assemble${{ matrix.flavor }}Release

    - name: Build AAB (Release)
      run: |
        cd android
        ./gradlew bundle${{ matrix.flavor }}Release

    - name: Upload APK artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.flavor }}-apk
        path: |
          build/app/outputs/flutter-apk/app-${{ matrix.flavor }}-debug.apk
          build/app/outputs/flutter-apk/app-${{ matrix.flavor }}-release.apk
        retention-days: 7

    - name: Upload AAB artifact
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.flavor }}-aab
        path: build/app/outputs/bundle/${{ matrix.flavor }}Release/app-${{ matrix.flavor }}-release.aab
        retention-days: 7

    - name: Build Summary
      run: |
        echo "## ✅ Build Successful for ${{ matrix.flavor }}" >> $GITHUB_STEP_SUMMARY
        echo "- **App ID**: ${{ matrix.app_id }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Debug APK**: ✅ Built" >> $GITHUB_STEP_SUMMARY
        echo "- **Release APK**: ✅ Built" >> $GITHUB_STEP_SUMMARY
        echo "- **Release AAB**: ✅ Built" >> $GITHUB_STEP_SUMMARY
        echo "- **Code Analysis**: ✅ Passed" >> $GITHUB_STEP_SUMMARY
        echo "- **Tests**: ✅ Passed" >> $GITHUB_STEP_SUMMARY

    - name: Cleanup
      if: always()
      run: |
        rm -f android/${{ matrix.key_file }}
        rm -f android/key.properties
