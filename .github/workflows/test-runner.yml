name: Test AWS Mac Runner

on:
  workflow_dispatch:
  push:
    branches: [ main ]
    paths:
      - '.github/workflows/test-runner.yml'

jobs:
  test-runner:
    runs-on: [self-hosted, macos, aws]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Test Environment
      run: |
        echo "ðŸ§ª Testing AWS Mac runner environment..."
        
        # Source environment variables
        source ~/.zshrc
        
        # Test Flutter
        echo "Flutter version:"
        flutter --version
        
        # Test Android SDK
        echo "Android SDK:"
        echo "ANDROID_HOME: $ANDROID_HOME"
        echo "ANDROID_SDK_ROOT: $ANDROID_SDK_ROOT"
        
        # Test Java
        echo "Java version:"
        java -version
        
        # Test project structure
        echo "Project files:"
        ls -la
        
        echo "âœ… Environment test completed"
        
    - name: Test Flutter Commands
      run: |
        echo "ðŸ§ª Testing Flutter commands..."
        
        # Source environment variables
        source ~/.zshrc
        
        # Test Flutter doctor
        flutter doctor --verbose
        
        # Test pub get
        flutter pub get
        
        # Test analyze
        flutter analyze
        
        echo "âœ… Flutter commands test completed"
        
    - name: Test Build (PACE only)
      run: |
        echo "ðŸ§ª Testing build for PACE flavor..."
        
        # Source environment variables
        source ~/.zshrc
        
        # Generate icons
        if [ -f "flutter_launcher_icons-pace.yaml" ]; then
          flutter pub run flutter_launcher_icons:main -f "flutter_launcher_icons-pace.yaml"
        fi
        
        # Test build (without signing for now)
        flutter build appbundle --release --flavor pace --target "lib/schools/pace/pace_main.dart" --verbose
        
        echo "âœ… Build test completed"
        
    - name: Cleanup
      if: always()
      run: |
        echo "ðŸ§¹ Cleaning up test build..."
        source ~/.zshrc
        flutter clean
        echo "âœ… Cleanup completed"
