name: Deploy to Play Store

on:
  push:
    branches: [ main, develop ]
    tags: [ 'v*' ]
  workflow_dispatch:
    inputs:
      flavor:
        description: 'Flavor to build and deploy'
        required: true
        default: 'pace'
        type: choice
        options:
          - pace
          - iiss
          - gaes
          - cbsa
          - dpsa
          - pmbs
          - pcbs
          - pbss
          - sisd
          - demo
      build_type:
        description: 'Build type'
        required: true
        default: 'release'
        type: choice
        options:
          - release
          - debug
      upload_to_play_store:
        description: 'Upload to Play Store'
        required: true
        default: true
        type: boolean

env:
  FLUTTER_VERSION: '3.24.0'

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        include:
          - flavor: pace
            app_id: com.pacesharjah.schoolapp
            key_file: pace_key.jks
            key_alias: pace
            track: production
          - flavor: iiss
            app_id: com.iiss.schoolapp
            key_file: pace_key.jks
            key_alias: pace
            track: production
          - flavor: gaes
            app_id: com.gaes.schoolapp
            key_file: gaes.key
            key_alias: key0
            track: production
          - flavor: cbsa
            app_id: com.cbsa.schoolapp
            key_file: pace_key.jks
            key_alias: pace
            track: production
          - flavor: dpsa
            app_id: com.dpsa.schoolapp
            key_file: pace_key.jks
            key_alias: pace
            track: production
          - flavor: pmbs
            app_id: com.pmbs.schoolapp
            key_file: pace_key.jks
            key_alias: pace
            track: production
          - flavor: pcbs
            app_id: com.pcbs.schoolapp
            key_file: pace_key.jks
            key_alias: pace
            track: production
          - flavor: pbss
            app_id: com.pbss.schoolapp
            key_file: pace_key.jks
            key_alias: pace
            track: production
          - flavor: sisd
            app_id: com.sisd.schoolapp
            key_file: pace_key.jks
            key_alias: pace
            track: production
          - flavor: demo
            app_id: com.demo.schoolapp
            key_file: pace_key.jks
            key_alias: pace
            track: internal

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Java
      uses: actions/setup-java@v4
      with:
        distribution: 'zulu'
        java-version: '17'

    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        channel: 'stable'

    - name: Get Flutter dependencies
      run: flutter pub get

    - name: Generate Flutter launcher icons
      run: |
        if [ -f "flutter_launcher_icons-${{ matrix.flavor }}.yaml" ]; then
          flutter pub run flutter_launcher_icons:main -f flutter_launcher_icons-${{ matrix.flavor }}.yaml
        fi

    - name: Setup signing key
      run: |
        # Create key.properties file for the specific flavor
        cat > android/key.properties << EOF
        storePassword=${{ secrets[format('{0}_STORE_PASSWORD', matrix.flavor)] }}
        keyAlias=${{ matrix.key_alias }}
        keyPassword=${{ secrets[format('{0}_KEY_PASSWORD', matrix.flavor)] }}
        storeFile=../${{ matrix.key_file }}
        EOF

    - name: Decode signing key
      run: |
        # Decode the keystore file from secrets
        echo "${{ secrets[format('{0}_KEYSTORE_BASE64', matrix.flavor)] }}" | base64 --decode > android/${{ matrix.key_file }}
        chmod 600 android/${{ matrix.key_file }}

    - name: Build APK
      run: |
        cd android
        ./gradlew assemble${{ matrix.flavor }}Release

    - name: Build AAB
      run: |
        cd android
        ./gradlew bundle${{ matrix.flavor }}Release

    - name: Upload APK artifact
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.flavor }}-apk
        path: build/app/outputs/flutter-apk/app-${{ matrix.flavor }}-release.apk
        retention-days: 30

    - name: Upload AAB artifact
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.flavor }}-aab
        path: build/app/outputs/bundle/${{ matrix.flavor }}Release/app-${{ matrix.flavor }}-release.aab
        retention-days: 30

    - name: Setup Google Play Console
      if: ${{ github.event.inputs.upload_to_play_store == 'true' || github.event_name != 'workflow_dispatch' }}
      uses: r0adkll/upload-google-play@v1
      with:
        serviceAccountJsonPlainText: ${{ secrets.GOOGLE_PLAY_SERVICE_ACCOUNT_JSON }}
        packageName: ${{ matrix.app_id }}
        releaseFiles: build/app/outputs/bundle/${{ matrix.flavor }}Release/app-${{ matrix.flavor }}-release.aab
        track: internal
        status: completed
        inAppUpdatePriority: 2
        userFraction: 1.0

    - name: Create Release
      if: startsWith(github.ref, 'refs/tags/')
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ github.ref }}
        release_name: Release ${{ github.ref }}
        body: |
          ## Flavor: ${{ matrix.flavor }}
          - **App ID**: ${{ matrix.app_id }}
          - **Build Type**: Release
          - **Track**: ${{ matrix.track }}
          
          ### Downloads
          - [APK](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
          - [AAB](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
        draft: false
        prerelease: false

    - name: Clean up sensitive files
      if: always()
      run: |
        rm -f android/${{ matrix.key_file }}
        rm -f android/key.properties

