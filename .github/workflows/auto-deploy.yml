name: Auto Deploy on Push

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  auto-deploy:
    runs-on: self-hosted  # Your AWS Mac machine
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Environment
      run: |
        echo "Setting up environment for auto-deploy..."
        # Use pre-installed Flutter and Android SDK
        export ANDROID_HOME="$ANDROID_HOME"
        export ANDROID_SDK_ROOT="$ANDROID_SDK_ROOT"
        export PATH="$PATH:$ANDROID_HOME/cmdline-tools/latest/bin:$ANDROID_HOME/platform-tools"
        
        echo "✅ Environment ready"
        echo "Flutter: $(which flutter)"
        echo "Android SDK: $ANDROID_HOME"
    
    - name: Get Dependencies
      run: |
        echo "Getting Flutter dependencies..."
        flutter pub get
        
    - name: Run Tests
      run: |
        echo "Running tests..."
        flutter test || echo "Some tests failed, but continuing..."
        
    - name: Run Analysis
      run: |
        echo "Running code analysis..."
        flutter analyze || echo "Analysis found issues, but continuing..."
        
    - name: Build All Flavors
      run: |
        echo "Building all flavors..."
        
        # Flavors to build
        FLAVORS=("pace" "gaes" "cbsa" "dpsa" "iiss" "pbss" "pcbs" "pmbs" "sisd")
        SUCCESS_COUNT=0
        TOTAL_COUNT=${#FLAVORS[@]}
        
        for flavor in "${FLAVORS[@]}"; do
          echo "Building $flavor..."
          
          # Generate icons
          if [ -f "flutter_launcher_icons-$flavor.yaml" ]; then
            flutter pub run flutter_launcher_icons:main -f "flutter_launcher_icons-$flavor.yaml"
          fi
          
          # Setup signing
          if [ "$flavor" = "gaes" ]; then
            cat > android/key.properties << EOF
        storePassword=\${GAES_STORE_PASSWORD}
        keyAlias=key0
        keyPassword=\${GAES_KEY_PASSWORD}
        storeFile=../gaes.key
        EOF
          else
            cat > android/key.properties << EOF
        storePassword=\${PACE_STORE_PASSWORD}
        keyAlias=pace
        keyPassword=\${PACE_KEY_PASSWORD}
        storeFile=../pace_key.jks
        EOF
          fi
          
          # Build AAB
          if flutter build appbundle --release --flavor "$flavor" --target "lib/schools/$flavor/${flavor}_main.dart"; then
            echo "✅ $flavor built successfully"
            ((SUCCESS_COUNT++))
            
            # Store locally
            mkdir -p ~/auto-builds/$(date +%Y%m%d_%H%M%S)
            cp "build/app/outputs/bundle/${flavor}Release/app-$flavor-release.aab" ~/auto-builds/$(date +%Y%m%d_%H%M%S)/$flavor-release.aab
          else
            echo "❌ $flavor build failed"
          fi
        done
        
        echo "Build Summary: $SUCCESS_COUNT/$TOTAL_COUNT flavors built successfully"
        
    - name: Create Build Summary
      run: |
        echo "Creating build summary..."
        BUILD_DIR=~/auto-builds/$(date +%Y%m%d_%H%M%S)
        mkdir -p "$BUILD_DIR"
        
        cat > "$BUILD_DIR/build_summary.txt" << EOF
        Auto Deploy Build Summary
        =========================
        
        Build Date: $(date)
        Triggered by: ${{ github.event.head_commit.message }}
        Commit: ${{ github.sha }}
        Branch: ${{ github.ref_name }}
        
        Flavors Built:
        EOF
        
        for flavor in pace gaes cbsa dpsa iiss pbss pcbs pmbs sisd; do
          if [ -f "$BUILD_DIR/$flavor-release.aab" ]; then
            size=$(ls -lh "$BUILD_DIR/$flavor-release.aab" | awk '{print $5}')
            echo "- $flavor: ✅ AAB ($size)" >> "$BUILD_DIR/build_summary.txt"
          else
            echo "- $flavor: ❌ Failed" >> "$BUILD_DIR/build_summary.txt"
          fi
        done
        
        echo "Build summary saved to: $BUILD_DIR/build_summary.txt"
        
    - name: Cleanup
      if: always()
      run: |
        echo "Cleaning up..."
        rm -f android/key.properties
        flutter clean
